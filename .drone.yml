---
kind: pipeline
name: test
type: docker

trigger:
  ref:
    - refs/heads/develop
    - refs/heads/VA-*

steps:
  - name: install
    image: node:latest
    commands:
    - npm install

  - name: deploy
    image: appleboy/drone-scp
    settings:
      host:
        from_secret: SSH_HOST
      username:
        from_secret: SSH_USER
      key:
        from_secret: SSH_KEY
      port: 22
      rm: true
      target: /var/www/webapps/vacms/vacmsapi
      source:
        - ./*
    when:
      branch:
        - dev

  - name: ssh
    image: appleboy/drone-ssh
    settings:
      host:
        from_secret: SSH_HOST
      username:
        from_secret: SSH_USER
      key:
        from_secret: SSH_KEY
      script:
        - cp /var/www/envs/vacms/.env.staging /var/www/webapps/vacms/vacmsapi/.env
        - pushd /var/www/webapps/vacms/vacmsapi
        - npm install
        - npm start
    when:
      branch:
        - develop

services:
  - name: redis
    image: redis

  - name: mysql
    image: mysql
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: "yes"
      MYSQL_DATABASE: test
